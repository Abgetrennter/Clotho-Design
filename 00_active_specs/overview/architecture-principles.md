# 架构原则

**版本**: 1.0.0
**日期**: 2025-12-30
**状态**: Draft
**作者**: Clotho 架构团队

---

## 1. 核心设计原则

### 1.1 凯撒原则 (The Caesar Principle)

> **"Render unto Caesar the things that are Caesar's, and unto God the things that are God's."**  
> **（凯撒的归凯撒，上帝的归上帝）**

#### 1.1.1 凯撒的归凯撒 (Code's Domain)

- **确定性逻辑**: 逻辑判断、数值计算、状态管理、流程控制必须由确定性代码严密掌控
- **绝不外包**: 严禁将此类逻辑外包给 LLM
- **代码权威**: Jacquard（编排层）和 Mnemosyne（数据层）拥有最终决策权

#### 1.1.2 上帝的归上帝 (LLM's Domain)

- **语义理解**: LLM 专注于语义理解、情感演绎、剧情生成、文本润色
- **神性保留**: 不分散 LLM 注意力于琐碎的逻辑计算
- **拒绝全权接管**: 不相信 LLM 能在处理复杂逻辑的同时保持高质量角色扮演

### 1.2 混合代理 (Hybrid Agency)

- **分工明确**: 人类提供意图，代码提供逻辑，LLM 提供语义
- **协同工作**: 三者各司其职，通过严格定义的协议交互
- **能力互补**: 发挥各自优势，避免短板效应

## 2. 系统架构原则

### 2.1 三层物理隔离

系统划分为三个物理隔离但逻辑紧密的层次：

1. **表现层 (Presentation)**
   - 职责: 用户交互与界面渲染
   - 技术: Flutter UI, Webview
   - 约束: **严禁包含业务逻辑**

2. **编排层 (Jacquard)**
   - 职责: 流程控制与 Prompt 组装
   - 特性: 插件化流水线，确定性编排
   - 核心: Skein 容器，模板渲染

3. **数据层 (Data & Infra)**
   - 职责: 数据存储、检索与快照生成
   - 组件: Mnemosyne 记忆引擎
   - 能力: 时空回溯，动态快照

### 2.2 单向数据流

- **UI → 逻辑**: UI 只能生成 Intent/Event，不能直接修改数据模型
- **逻辑 → UI**: 逻辑层通过 Stream 广播状态变更，UI 被动接收并重绘
- **数据权威**: Mnemosyne 是唯一的状态权威源

### 2.3 协议统一化 (Filament Unification)

- **统一格式**: "XML + YAML IN, XML + JSON OUT"
- **统一范畴**: 贯穿提示词格式、标签类型、嵌入式前端、状态管理
- **统一解析**: 实时流式解析，路由分发

## 3. 开发与维护原则

### 3.1 绝对约束 (The "Must-Nots")

1. **UI 层严禁包含业务逻辑**: UI 组件不得直接修改数据模型
2. **LLM 输出严禁直接执行**: 必须经过 Parser 清洗与校验，严禁 `eval`
3. **状态严禁多头管理**: 所有状态变更必须提交给 Mnemosyne 统一处理
4. **严禁 Prompt 污染**: 严禁在 Prompt 中包含复杂的逻辑运算指令

### 3.2 可扩展性原则

- **插件化**: Jacquard 采用插件化流水线，支持自定义逻辑单元
- **模板化**: 使用 Jinja2 模板引擎，支持动态逻辑控制
- **协议化**: Filament 协议提供标准化的扩展接口

### 3.3 兼容性原则

- **向后兼容**: 支持 SillyTavern 角色卡导入与迁移
- **向前兼容**: 协议版本演进保持兼容性
- **生态兼容**: 通过 WebView 兼容第三方 HTML/JS 内容

## 4. 性能与质量原则

### 4.1 性能基调

- **首屏加载**: < 1s
- **长列表滚动**: 60fps（即使在大量消息历史下）
- **内存占用**: 严格控制图片与上下文对象缓存策略
- **响应时间**: 用户操作到视觉反馈 < 100ms

### 4.2 质量属性

- **可靠性**: 异常转化机制，防止崩溃传播
- **可维护性**: 清晰的架构分层，模块化设计
- **可测试性**: 依赖倒置，支持单元测试和集成测试
- **可观测性**: 完整的日志和监控体系

### 4.3 安全原则

- **沙箱隔离**: 脚本运行在受限沙箱中
- **输入验证**: 所有外部输入必须经过严格验证
- **权限控制**: 细粒度的数据访问权限
- **隐私保护**: 用户数据本地优先，可选加密

## 5. 演进与变更原则

### 5.1 版本管理

- **语义化版本**: 遵循语义化版本规范
- **协议版本**: Filament 协议独立版本管理
- **数据迁移**: 提供自动化数据迁移工具

### 5.2 变更控制

- **架构变更**: 必须经过架构评审委员会批准
- **协议变更**: 保持向后兼容，提供迁移指南
- **数据变更**: 支持数据结构的渐进式演进

### 5.3 文档同步

- **代码即文档**: 关键设计决策必须在代码注释中记录
- **文档更新**: 架构变更必须同步更新相关文档
- **知识共享**: 建立架构决策记录 (ADR) 库

## 6. 关联文档

- **[愿景与哲学](vision-and-philosophy.md)**: 项目根本指导思想
- **[核心架构](../core/README.md)**: 具体组件实现原则
- **[Filament 协议](../protocols/filament-protocol-overview.md)**: 协议设计原则
- **[分层运行时架构](../runtime/layered-runtime-architecture.md)**: 运行时设计原则

---

**最后更新**: 2025-12-30  
**文档状态**: 草案，待架构评审委员会审议
