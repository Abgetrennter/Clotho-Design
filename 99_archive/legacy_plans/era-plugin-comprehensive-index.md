# ERA 插件综合技术索引

**版本**: 1.0.0
**日期**: 2025-12-28
**状态**: Final
**作者**: Architect Mode

---

## 文档概述

本文档是 ERA 变量框架的综合技术索引，整合了四份深度分析文档的核心内容，为开发者提供快速查找和导航的参考工具。

**整合的源文档**：
1. `era-framework-architecture-analysis.md` - ERA 变量框架技术架构分析
2. `era-clotho-comparative-analysis.md` - ERA 与 Clotho 架构对比分析
3. `event-driven-architecture-deep-dive.md` - 事件驱动架构深度分析
4. `template-inheritance-deep-dive.md` - 模板继承机制深度分析

---

## 目录导航

### 一、框架总体架构

| 章节标题 | 核心内容 | 相关文档 |
|----------|----------|----------|
| [架构概览](#一框架总体架构) | 分层事件驱动架构、模块划分 | 架构分析文档 |
| [核心设计原则](#核心设计原则) | SOLID 原则、关注点分离 | 架构分析文档 |
| [数据存储架构](#数据存储架构) | ERAMetaData、stat_data 结构 | 架构分析文档 |
| [核心设计理念](#核心设计理念对比) | 语义化操作、模板驱动、保护机制 | 竞品对比文档 |

### 二、核心功能实现路径

| 章节标题 | 核心内容 | 相关文档 |
|----------|----------|----------|
| [MK 管理系统](#消息密钥mk管理) | 消息密钥生成、注入、读取 | 架构分析文档 |
| [状态同步机制](#状态同步机制) | 逆序回滚、顺序重算 | 架构分析文档 |
| [CRUD 操作](#crud-操作实现) | Insert、Update、Delete 实现 | 架构分析文档 |
| [宏系统](#宏系统详解) | 宏解析、自动刷新、占位符 | 架构分析文档 |
| [初始化机制](#初始化机制) | 世界书初始化、正则表达式初始化 | 架构分析文档 |

### 三、事件驱动架构原理

| 章节标题 | 核心内容 | 相关文档 |
|----------|----------|----------|
| [事件系统架构](#事件系统详解) | 事件入口、队列、合并、分发 | 架构分析文档 |
| [统一事件总线](#统一事件总线) | eventEmit/eventOn 接口 | 事件驱动文档 |
| [事件负载](#事件负载) | WriteDonePayload、QueryResultPayload | 事件驱动文档 |
| [防循环机制](#防循环机制) | apiWrite 标识防止无限循环 | 事件驱动文档 |

### 四、模板继承机制

| 章节标题 | 核心内容 | 相关文档 |
|----------|----------|----------|
| [模板定义](#模板定义) | $template 字段、模板结构 | 架构分析文档 |
| [继承规则](#模板继承规则) | 优先级、覆盖、嵌套继承 | 模板继承文档 |
| [模板应用](#模板应用) | Insert 操作中的模板应用 | 架构分析文档 |
| [约束继承](#约束继承) | $meta 约束通过模板继承 | 模板继承文档 |

### 五、竞品对比分析

| 章节标题 | 核心内容 | 相关文档 |
|----------|----------|----------|
| [设计理念对比](#核心设计理念对比) | ERA vs Clotho 设计理念 | 竞品对比文档 |
| [变量操作对比](#变量操作机制对比) | XML 标签 vs OpCode | 竞品对比文档 |
| [状态管理对比](#状态管理对比) | 模板系统 vs VWD 模型 | 竞品对比文档 |
| [事件系统对比](#ui-交互与事件系统对比) | 统一事件总线 vs 分散式处理 | 竞品对比文档 |
| [可借鉴设计](#可借鉴的设计模式) | ERA ↔ Clotho 相互借鉴 | 竞品对比文档 |

---

## 关键技术概念索引

### A-Z 索引

| 概念 | 说明 | 位置 |
|------|------|------|
| **ActionsTaken** | 操作追踪对象，记录本轮执行的所有操作 | 架构分析文档 §9.1 |
| **EditLogs** | 编辑日志对象，以 MK 为键记录变量变更 | 架构分析文档 §3.1 |
| **ERA 变量框架** | SillyTavern 的变量管理插件 | 架构分析文档 §1 |
| **eventEmit/eventOn** | 酒馆助手提供的事件接口 | 架构分析文档 §4.1 |
| **EVENT_GROUPS** | 事件分组定义（INIT、SYNC、API 等） | 架构分析文档 §4.1 |
| **EventJob** | 事件队列中的任务对象 | 架构分析文档 §4.2 |
| **Filament 协议** | Clotho 的统一协议（XML+YAML 输入，XML+JSON 输出） | 竞品对比文档 §1 |
| **Hybrid SDUI** | Clotho 的混合扩展策略（原生轨道 + Web 轨道） | 竞品对比文档 §3 |
| **Jacquard** | Clotho 的确定性编排流水线 | 竞品对比文档 §1 |
| **Keyframe** | Clotho 的时间旅行机制（关键帧 + Delta） | 竞品对比文档 §1 |
| **MK (Message Key)** | 消息密钥，ERA 的核心创新 | 架构分析文档 §5.1 |
| **Mnemosyne** | Clotho 的数据引擎 | 竞品对比文档 §1 |
| **OpCode** | Clotho 的操作码（SET、ADD、SUB 等） | 竞品对比文档 §3 |
| **QueryResultPayload** | 查询结果事件负载 | 架构分析文档 §8.2 |
| **QuickJS/LuaJIT** | Clotho 的沙箱引擎 | 竞品对比文档 §1 |
| **RFW** | Clotho 的原生渲染框架 | 竞品对比文档 §3 |
| **SelectedMks** | 已选择消息密钥链，稀疏数组 | 架构分析文档 §3.1 |
| **stat_data** | 状态数据根路径，存储游戏/故事变量 | 架构分析文档 §3.1 |
| **VWD (Value with Description)** | Clotho 的数据模型（值与描述分离） | 竞品对比文档 §3 |
| **VariableDelete** | ERA 的删除操作标签 | 架构分析文档 §5.3.3 |
| **VariableEdit** | ERA 的更新操作标签 | 架构分析文档 §5.3.2 |
| **VariableInsert** | ERA 的插入操作标签 | 架构分析文档 §5.3.1 |
| **VariableThink** | ERA 的思考标签 | 竞品对比文档 §6 |
| **WriteDonePayload** | 写入完成事件负载 | 架构分析文档 §8.2 |

---

## API 接口索引

### 写入类 API

| API 名称 | 参数 | 功能 | 文档位置 |
|---------|------|------|----------|
| `era:insertByObject` | `object` | 非破坏性插入变量 | 架构分析文档 §8.1 |
| `era:updateByObject` | `object` | 修改已存在的变量 | 架构分析文档 §8.1 |
| `era:insertByPath` | `path`, `value` | 通过路径插入变量 | 架构分析文档 §8.1 |
| `era:updateByPath` | `path`, `value` | 通过路径修改变量 | 架构分析文档 §8.1 |
| `era:deleteByObject` | `object` | 通过对象结构删除变量 | 架构分析文档 §8.1 |
| `era:deleteByPath` | `path` | 通过路径删除变量 | 架构分析文档 §8.1 |
| `era:forceSync` | `mode`, `message_id` | 强制同步变量状态 | 架构分析文档 §8.3 |

### 查询类 API

| API 名称 | 参数 | 返回 | 文档位置 |
|---------|------|------|----------|
| `era:getCurrentVars` | 无 | 当前变量状态 | 架构分析文档 §8.2 |
| `era:getSnapshotAtMk` | `mk` | 指定 MK 的快照 | 架构分析文档 §8.2 |
| `era:getSnapshotsBetweenMks` | `startMk`, `endMk` | 两个 MK 之间的快照 | 架构分析文档 §8.2 |
| `era:getSnapshotAtMId` | `message_id` | 指定消息 ID 的快照 | 架构分析文档 §8.2 |
| `era:getSnapshotsBetweenMIds` | `startId`, `endId` | 两个消息 ID 之间的快照 | 架构分析文档 §8.2 |
| `era:requestWriteDone` | 无 | 重新广播 writeDone 事件 | 架构分析文档 §8.3 |

### 广播类事件

| 事件名称 | 负载 | 说明 | 文档位置 |
|---------|------|------|----------|
| `era:writeDone` | `WriteDonePayload` | 变量写入完成通知 | 架构分析文档 §8.2 |
| `era:queryResult` | `QueryResultPayload` | 查询结果通知 | 架构分析文档 §8.2 |

---

## 文件路径索引

### 核心模块文件

| 文件路径 | 功能 | 文档位置 |
|---------|------|----------|
| `index.ts` | 事件入口，注册监听器 | 架构分析文档 §4.1 |
| `events/queue.ts` | 事件队列管理 | 架构分析文档 §4.2 |
| `events/merger.ts` | 事件合并与对冲检测 | 架构分析文档 §4.3 |
| `events/dispatcher.ts` | 事件分发与路由 | 架构分析文档 §4.4 |
| `events/handlers/sync.ts` | 同步处理器 | 架构分析文档 §4.4 |
| `events/handlers/write.ts` | 写入处理器 | 架构分析文档 §4.4 |
| `events/handlers/api/handler.ts` | API 处理器 | 架构分析文档 §4.4 |
| `core/sync.ts` | 状态同步（逆序回滚，顺序重算） | 架构分析文档 §5.2 |
| `core/key/mk.ts` | MK 管理系统 | 架构分析文档 §5.1 |
| `core/crud/insert/insert.ts` | 插入操作实现 | 架构分析文档 §5.3.1 |
| `core/crud/insert/template.ts` | 模板继承机制 | 架构分析文档 §5.3.1 |
| `core/crud/update.ts` | 更新操作实现 | 架构分析文档 §5.3.2 |
| `core/crud/delete.ts` | 删除操作实现 | 架构分析文档 §5.3.3 |
| `core/snapshot.ts` | 快照管理 | 架构分析文档 §5 |
| `macro/parser.ts` | 宏解析与替换 | 架构分析文档 §6.1 |
| `macro/placeholder.ts` | 占位符管理 | 架构分析文档 §6.3 |
| `initer/manual/worldbook.ts` | 世界书初始化 | 架构分析文档 §7.1 |
| `initer/manual/regex.ts` | 正则表达式初始化 | 架构分析文档 §7.2 |
| `ui/store.ts` | UI 状态管理 | 架构分析文档 §2.1 |
| `utils/constants.ts` | 核心常量定义 | 架构分析文档 §3.3 |

---

## 设计模式索引

| 设计模式 | 应用场景 | 说明 | 文档位置 |
|---------|---------|------|----------|
| **事件驱动架构** | 整体系统架构 | 所有外部交互通过事件系统进行 | 架构分析文档 §10.1 |
| **命令模式** | 变量操作 | 变量操作通过指令对象描述 | 架构分析文档 §10.1 |
| **策略模式** | CRUD 操作 | 不同操作类型有不同的执行策略 | 架构分析文档 §10.1 |
| **模板方法模式** | 模板继承 | 支持多层嵌套和特异性规则 | 架构分析文档 §10.1 |
| **观察者模式** | 事件通知 | writeDone 事件通知外部脚本 | 架构分析文档 §10.1 |
| **责任链模式** | 事件合并 | 事件合并器依次应用合并规则 | 架构分析文档 §10.1 |
| **单例模式** | 日志记录 | Logger 类实现统一日志记录 | 架构分析文档 §10.1 |

---

## 技术挑战与解决方案索引

| 技术挑战 | 解决方案 | 文档位置 |
|----------|---------|----------|
| 消息变量错位 | MK 系统（消息密钥注入到内容） | 架构分析文档 §10.2 |
| 孤儿变量继承 | MK 确保每个消息有独立标识符 | 架构分析文档 §10.2 |
| 并发状态竞争 | 事件队列的单线程锁 | 架构分析文档 §10.2 |
| 历史追溯复杂性 | EditLogs + findLatestNewValue() | 架构分析文档 §10.2 |
| 模板继承链 | 明确的优先级规则 | 架构分析文档 §10.2 |
| 事件循环风险 | apiWrite 标识防止无限循环 | 事件驱动文档 §5.2.3 |

---

## 快速查找指南

### 我想了解...

**框架的整体结构**
→ 参见 [框架总体架构](#一框架总体架构)

**如何进行变量操作**
→ 参见 [核心功能实现路径](#二核心功能实现路径)

**事件系统如何工作**
→ 参见 [事件驱动架构原理](#三事件驱动架构原理)

**模板继承机制**
→ 参见 [模板继承机制](#四模板继承机制)

**ERA 与其他系统的对比**
→ 参见 [竞品对比分析](#五竞品对比分析)

**如何使用 API**
→ 参见 [API 接口索引](#api-接口索引)

**MK 系统的原理**
→ 参见 [消息密钥 MK 管理](#消息密钥mk管理)

**如何解决消息变量错位问题**
→ 参见 [技术挑战与解决方案索引](#技术挑战与解决方案索引)

**事件防循环机制**
→ 参见 [防循环机制](#防循环机制)

**模板优先级规则**
→ 参见 [模板继承规则](#模板继承规则)

---

## 相关文档链接

| 文档名称 | 路径 | 说明 |
|---------|------|------|
| ERA 变量框架技术架构分析 | `plans/era-framework-architecture-analysis.md` | 完整的框架架构分析 |
| ERA 与 Clotho 架构对比分析 | `plans/era-clotho-comparative-analysis.md` | ERA 与 Clotho 的详细对比 |
| 事件驱动架构深度分析 | `plans/event-driven-architecture-deep-dive.md` | 事件驱动架构的深入探讨 |
| 模板继承机制深度分析 | `plans/template-inheritance-deep-dive.md` | 模板继承机制的详细说明 |
| ERA 插件综合技术文档 | `plans/era-plugin-comprehensive-document.md` | 按五个板块组织的完整技术文档 |

---

## 版本历史

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| 1.0.0 | 2025-12-28 | 初始版本，整合四份分析文档 |

---

## 文档维护

本文档基于以下源文档整合而成，如需更新源文档，请同步更新本索引：
1. `era-framework-architecture-analysis.md`
2. `era-clotho-comparative-analysis.md`
3. `event-driven-architecture-deep-dive.md`
4. `template-inheritance-deep-dive.md`
