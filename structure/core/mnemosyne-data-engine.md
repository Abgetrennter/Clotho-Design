# ç¬¬ä¸‰ç« ï¼šæ•°æ®ä¸­æ¢ä¸è®°å¿†å¼•æ“ (Mnemosyne Layer)

**ç‰ˆæœ¬**: 1.0.0
**æ—¥æœŸ**: 2025-12-23
**çŠ¶æ€**: Draft
**ä½œè€…**: èµ„æ·±ç³»ç»Ÿæ¶æ„å¸ˆ (Architect Mode)
**æºæ–‡æ¡£**: `system_architecture.md`, `mvu_integration_design.md`

---

## 1. å¼•æ“æ¦‚è§ˆ (Mnemosyne Overview)

**Mnemosyne** æ˜¯æ•°æ®å±‚çš„æ ¸å¿ƒï¼Œå®ƒä¸å†ä»…ä»…æ˜¯é™æ€æ•°æ®çš„ä»“åº“ï¼Œè€Œæ˜¯å‡çº§ä¸º **åŠ¨æ€ä¸Šä¸‹æ–‡ç”Ÿæˆå¼•æ“ (Dynamic Context Generation Engine)**ã€‚å®ƒè´Ÿè´£ç®¡ç†ç³»ç»Ÿçš„â€œé•¿æœŸè®°å¿†â€ä¸â€œç¬æ—¶çŠ¶æ€â€ï¼Œå¹¶ä¸ºç¼–æ’å±‚æä¾›ç²¾å‡†çš„ä¸Šä¸‹æ–‡å¿«ç…§ã€‚

### 1.1 æ ¸å¿ƒèŒè´£

1. **æ•°æ®æ‰˜ç®¡**: ç®¡ç† Lorebook, Presets, World Rulesã€‚
2. **æ··åˆäº‹ä»¶å­˜å‚¨**: åŒºåˆ† **æ•°å€¼ (VWD)** ä¸ **äº‹ä»¶ (Events)**ï¼Œå®ç°æ—¥å¸¸äº’åŠ¨ä¸å…³é”®å‰§æƒ…çš„åˆ†ç¦»å¤„ç†ã€‚
3. **å¿«ç…§ç”Ÿæˆ**: æ ¹æ® Time Pointer èšåˆæ•°æ®ï¼Œç”Ÿæˆä¸å¯å˜çš„ `Punchcards`ã€‚
4. **çŠ¶æ€ç®¡ç†**: ç»´æŠ¤ RPG å˜é‡ï¼Œå¤„ç† VWD (Value with Description) æ•°æ®æ¨¡å‹ï¼Œå¹¶æ‰§è¡Œ **ACL è®¿é—®æ§åˆ¶**ã€‚

---

## 2. å¤šç»´ä¸Šä¸‹æ–‡é“¾ (Multi-dimensional Context Chains)

è™½ç„¶æ•°æ®åœ¨ç‰©ç†ä¸Šä»¥ **å¢é‡ (Incremental)** å½¢å¼å­˜å‚¨ï¼Œä½†åœ¨é€»è¾‘ä¸Šï¼ŒMnemosyne å°†å…¶æŠ•å½±ä¸ºæ•°æ¡å¹³è¡Œçš„ **ä¸Šä¸‹æ–‡é“¾ç½‘**ã€‚

### 2.1 é“¾ç½‘ç»“æ„

1. **History Chain (å†å²é“¾)**:
    * å†…å®¹: æ ‡å‡†å¯¹è¯è®°å½•ã€‚
    * é€»è¾‘: çº¿æ€§æŠ•å½±ï¼Œæä¾› LLM ç†è§£å‰§æƒ…çš„è¿è´¯æ€§ã€‚
2. **State Chain (çŠ¶æ€é“¾)**:
    * å†…å®¹: ç»“æ„åŒ–çš„ RPG æ•°å€¼ä¸çŠ¶æ€ (VWD State Tree)ã€‚
    * ç­–ç•¥: **ç¨€ç–å¿«ç…§ (Sparse Snapshots) + æ“ä½œæ—¥å¿— (OpLog)**ã€‚
    * ä½œç”¨: ç¡®ä¿â€œæ—¶é—´æ—…è¡Œâ€æ—¶ï¼Œä¸–ç•ŒçŠ¶æ€èƒ½ç²¾ç¡®å›æ»šï¼Œå¹¶ä¼˜åŒ–é•¿å¯¹è¯æ€§èƒ½ã€‚
3. **Event Chain (äº‹ä»¶é“¾)**:
    * å†…å®¹: å…¨å±€äº‹ä»¶ (Global Events) ä¸ è§’è‰²ç§æœ‰æ—¥å¿— (Character Logs)ã€‚
    * é€»è¾‘: æ°¸ä¹…å­˜å‚¨å…³é”®å‰§æƒ…èŠ‚ç‚¹ï¼Œæ”¯æŒç»“æ„åŒ–æŸ¥è¯¢ã€‚
4. **RAG Chain (æ£€ç´¢å¢å¼ºé“¾)**:
    * å†…å®¹: å‘é‡åŒ–çš„è®°å¿†ç‰‡æ®µã€‚
    * é€»è¾‘: åŸºäº History çš„è¯­ä¹‰æ£€ç´¢ç»“æœï¼ŒåŠ¨æ€æ³¨å…¥èƒŒæ™¯çŸ¥è¯†ã€‚

### 2.2 Context Pipeline å·¥ä½œæµ

å½“ Jacquard è¯·æ±‚å¿«ç…§æ—¶ï¼ŒPipeline æ‰§è¡Œ **æŠ•å½± (Projection)** æ“ä½œï¼š

1. **Trace**: æ ¹æ® Session Pointer å›æº¯æ ‘è·¯å¾„ã€‚
2. **Restore**: æŸ¥æ‰¾æœ€è¿‘å¿«ç…§å¹¶åº”ç”¨ OpLogï¼Œæ¢å¤åŸºç¡€çŠ¶æ€ã€‚
3. **Lazy View**: è¿”å› `Punchcards` ä»£ç†å¯¹è±¡ï¼Œä»…åœ¨è®¿é—®æ—¶æ‰§è¡Œ Deep Mergeï¼ˆæƒ°æ€§æ±‚å€¼ï¼‰ã€‚
4. **ACL Filtering**: å¯¹ RAG æ£€ç´¢ç»“æœå’Œ Event Chain å†…å®¹è¿›è¡Œæƒé™è¿‡æ»¤ (Global/Shared/Private)ã€‚

---

## 3. Value with Description (VWD) æ•°æ®æ¨¡å‹

ä¸ºäº†è§£å†³â€œæ•°å€¼å¯¹ LLM ç¼ºä¹è¯­ä¹‰â€çš„é—®é¢˜ï¼Œæˆ‘ä»¬å¼•å…¥äº† MVU çš„ **VWD** æ¨¡å‹ã€‚

### 3.1 ç»“æ„å®šä¹‰

çŠ¶æ€èŠ‚ç‚¹ä¸å†æ˜¯ç®€å•çš„ Key-Valueï¼Œè€Œæ˜¯æ”¯æŒ `[Value, Description]` çš„å¤åˆç»“æ„ã€‚

```dart
// Dart ä¼ªä»£ç 
class StateNode {
  dynamic value;          // å®é™…å€¼ (80)
  String? description;    // è¯­ä¹‰æè¿° ("HP, 0 is dead")
  
  dynamic toJson() => description == null ? value : [value, description];
}
```

### 3.2 æ¸²æŸ“ç­–ç•¥

* **System Prompt (ç»™ LLM çœ‹)**: æ¸²æŸ“å®Œæ•´çš„ `[Value, Description]`ï¼Œè®© LLM ç†è§£å˜é‡å«ä¹‰ã€‚
  * `"health": [80, "HP, 0 is dead"]`
* **UI Display (ç»™ç”¨æˆ·çœ‹)**: ä»…æ¸²æŸ“ `Value`ã€‚
  * `Health: 80`

---

## 4. çŠ¶æ€ Schema ä¸å…ƒæ•°æ® ($meta)

ä¸ºäº†è§„èŒƒçŠ¶æ€æ ‘çš„ç»“æ„å¹¶å¢å¼ºæ•°æ®å¼•æ“çš„çµæ´»æ€§ï¼ŒMnemosyne æ”¯æŒ `$meta` å­—æ®µå®šä¹‰çº¦æŸã€æ¨¡æ¿ä¸æƒé™ã€‚

### 4.1 æ ¸å¿ƒå…ƒæ•°æ®å®šä¹‰

* **template**: å®šä¹‰å½“å‰å±‚çº§åŠå…¶å­å±‚çº§çš„é»˜è®¤ç»“æ„ï¼ˆæ”¯æŒå¤šçº§ç»§æ‰¿ï¼‰ã€‚
* **updatable**: æ˜¯å¦å…è®¸ä¿®æ”¹è¯¥èŠ‚ç‚¹çš„å€¼ï¼ˆé»˜è®¤ trueï¼‰ã€‚
* **necessary**: åˆ é™¤ä¿æŠ¤çº§åˆ« (`self` | `children` | `all`)ã€‚
* **description**: è¯­ä¹‰åŒ–æè¿°ï¼ˆVWD é›†æˆï¼‰ã€‚
* **extensible**: æ˜¯å¦å…è®¸ LLM åœ¨æ ¹èŠ‚ç‚¹ä¸‹æ·»åŠ æ–°å±æ€§ã€‚
* **required**: å¿…é¡»å­˜åœ¨çš„å­—æ®µåˆ—è¡¨ã€‚

### 4.2 å¤šçº§æ¨¡æ¿ç»§æ‰¿ (Multi-level Template Inheritance) - v1.1

Mnemosyne æ”¯æŒåœ¨çŠ¶æ€æ ‘ä¸­å®šä¹‰ `$meta.template`ï¼Œå¹¶åœ¨æ•°æ®è®¿é—®æ—¶åŠ¨æ€è®¡ç®—ç»§æ‰¿é“¾ã€‚

**ç»§æ‰¿é€»è¾‘**:

1. **å‘ä¸ŠæŸ¥æ‰¾**: ä»ç›®æ ‡èŠ‚ç‚¹å‘ä¸Šéå†è‡³æ ¹èŠ‚ç‚¹ï¼Œæ”¶é›†æ‰€æœ‰ `$meta.template`ã€‚
2. **æ·±åº¦åˆå¹¶**: æŒ‰ "çˆ¶çº§ -> å­çº§ -> è‡ªèº«æ•°æ®" çš„é¡ºåºè¿›è¡Œæ·±åº¦åˆå¹¶ (Deep Merge)ã€‚
3. **è¦†ç›–æœºåˆ¶**: å­çº§æ¨¡æ¿è¦†ç›–çˆ¶çº§ï¼Œå®é™…æ•°æ®è¦†ç›–æ‰€æœ‰æ¨¡æ¿ã€‚

**ç¤ºä¾‹**:

```json
{
  "characters": {
    "$meta": {
      "template": { "hp": 100, "level": 1 } // åŸºç±»æ¨¡æ¿
    },
    "npcs": {
      "$meta": {
        "template": { "faction": "neutral" } // å­ç±»æ¨¡æ¿ï¼Œç»§æ‰¿ hp=100
      },
      "guard": { "class": "Warrior" } // å®é™…æ•°æ®ï¼Œéšå« hp=100, faction=neutral
    }
  }
}
```

### 4.3 ç»†ç²’åº¦æƒé™æ§åˆ¶ (Fine-grained Permission) - v1.1

å¼•å…¥ `$meta.necessary` å’Œ `$meta.updatable` å®ç°æ•°æ®ä¿æŠ¤ã€‚

| æƒé™å­—æ®µ | å€¼ | è¡Œä¸º |
| :--- | :--- | :--- |
| **necessary** | `"self"` | ä¿æŠ¤èŠ‚ç‚¹è‡ªèº«ä¸è¢«åˆ é™¤ |
| | `"children"` | ä¿æŠ¤ç›´å±å­èŠ‚ç‚¹ä¸è¢«åˆ é™¤ |
| | `"all"` | ä¿æŠ¤æ•´ä¸ªå­æ ‘ä¸è¢«åˆ é™¤ |
| **updatable** | `false` | é”å®šèŠ‚ç‚¹å€¼ï¼Œç¦æ­¢ä¿®æ”¹ï¼ˆé™¤éæ“ä½œæ˜¾å¼è¦†ç›–ï¼‰ |

### 4.4 å®Œæ•´ Schema ç¤ºä¾‹

```json
{
  "character": {
    "$meta": {
      "extensible": false,
      "required": ["health", "mood"]
    },
    "health": [100, "å½“å‰ç”Ÿå‘½å€¼"],
    "inventory": {
      "$meta": {
        "extensible": true,
        "template": {
           "name": "Unknown Item", 
           "desc": "ç‰©å“æè¿°",
           "$meta": { "necessary": "self" }
        }
      }
    }
  }
}
```

---

## 5. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ (Performance Strategy)

ä¸ºäº†åº”å¯¹é•¿å¯¹è¯ï¼ˆ1000+ è½®æ¬¡ï¼‰å’Œå¤æ‚è§’è‰²å¡ï¼ˆå‡ åƒæ¡ World Infoï¼‰å¸¦æ¥çš„æ€§èƒ½æŒ‘æˆ˜ï¼ŒMnemosyne é‡‡ç”¨äº†æ¿€è¿›çš„ä¼˜åŒ–ç­–ç•¥ã€‚

### 5.1 ç¨€ç–å¿«ç…§ä¸ OpLog (Sparse Snapshots & OpLog)

ä¼ ç»Ÿçš„ "Keyframe + Delta" åœ¨é•¿å¯¹è¯ä¸­ä¼šå›  Delta é“¾è¿‡é•¿å¯¼è‡´è¯»å–æ€§èƒ½å´©å¡Œã€‚æˆ‘ä»¬å¼•å…¥äº† **ç¨€ç–å¿«ç…§** æœºåˆ¶ï¼š

* **å¿«ç…§å¯†åº¦**: å¼ºåˆ¶æ¯ **50 è½®** å¯¹è¯ç”Ÿæˆä¸€ä¸ªå…¨é‡ Keyframeã€‚
* **é‡å»ºé€»è¾‘**: æŸ¥æ‰¾æœ€è¿‘çš„å‰å‘ Keyframe -> é¡ºåºåº”ç”¨éšåçš„ Deltasã€‚
* **ç»“æ„ä¼˜åŒ– (OpLog)**: Delta ä¸å†æ˜¯ç®€å•çš„ JSON Diffï¼Œè€Œæ˜¯ç»“æ„åŒ–çš„æ“ä½œæ—¥å¿—ï¼Œéµå¾ª JSON Patch æ ‡å‡†ï¼š

    ```json
    { "op": "replace", "path": "/character/hp", "value": 80 }
    ```

### 5.2 æƒ°æ€§æ±‚å€¼è§†å›¾ (Lazy Evaluation View)

ä¸ºäº†é¿å…åœ¨æ¯æ¬¡ Trace æ—¶å…¨é‡ç»„è£…åºå¤§çš„ Lorebook å’Œå¤æ‚çš„è§’è‰²çŠ¶æ€ï¼ŒMnemosyne è¿›åŒ–ä¸º **æŒ‰éœ€åŠ è½½**ã€‚

* **ç°çŠ¶**: Trace -> Project -> Assemble -> Punchcards (å…¨é‡è®¡ç®—)ã€‚
* **ä¼˜åŒ–**: `Punchcards` è¿”å›çš„æ˜¯ä¸€ä¸ª **Proxy (ä»£ç†å¯¹è±¡)**ã€‚
* **è§¦å‘æœºåˆ¶**:
  * åªæœ‰å½“ Jinja2 æ¨¡æ¿çœŸæ­£è®¿é—®å˜é‡ï¼ˆå¦‚ `{{ character.inventory }}`ï¼‰æ—¶ï¼ŒMnemosyne æ‰ä¼šå»è®¡ç®—è¯¥èŠ‚ç‚¹çš„æœ€ç»ˆçŠ¶æ€ã€‚
  * å¯¹äºæœªè¢«å¼•ç”¨çš„æ•°æ®ï¼ˆå¦‚æ·±åŸ‹çš„ Loreï¼‰ï¼Œè·³è¿‡ Deep Merge è¿‡ç¨‹ï¼Œæ˜¾è‘—é™ä½ I/O å’Œ CPU å¼€é”€ã€‚

### 5.3 çŠ¶æ€æ›´æ–°æµç¨‹

1. Jacquard è§£æå‡º `State Delta`ã€‚
2. Mnemosyne æ¥æ”¶ Deltaï¼Œå†™å…¥ OpLogã€‚
3. æ£€æŸ¥æ˜¯å¦è¾¾åˆ°å¿«ç…§é˜ˆå€¼ï¼ˆ50è½®ï¼‰ï¼Œè‹¥è¾¾åˆ°åˆ™å¼‚æ­¥ç”Ÿæˆæ–°çš„ Keyframeã€‚
4. è®¡ç®—ç”¨äº UI å±•ç¤ºçš„ **Display Data** (çº¯å€¼) å’Œ **Change Log**ã€‚

### 5.4 ç¡®å®šæ€§å›æº¯

ç”±äºé‡‡ç”¨äº† OpLog å›æ”¾æœºåˆ¶ï¼Œå½“ç”¨æˆ·å›æ»šåˆ°ä¹‹å‰çš„æ¶ˆæ¯æ—¶ï¼ŒMnemosyne èƒ½ç¬é—´é‡å»ºå½“æ—¶çš„çŠ¶æ€ï¼Œç¡®ä¿å‰§æƒ…ä¸æ•°å€¼çš„å®Œç¾ä¸€è‡´ã€‚

## 6. L3 Patching æœºåˆ¶é›†æˆ

### 6.1 æœºåˆ¶æ‘˜è¦

Mnemosyne è´Ÿè´£æ‰§è¡Œ **L3 (Session State)** å±‚å¯¹ **L2 (Character Assets)** å±‚çš„åŠ¨æ€è¡¥ä¸åº”ç”¨ã€‚

å…·ä½“çš„ **Patching å·¥ä½œåŸç†**ã€**Deep Merge ç®—æ³•** ä»¥åŠ **åˆ†å±‚æ¶æ„å®šä¹‰**ï¼Œå·²è¿ç§»è‡³å•ä¸€äº‹å®æ¥æº (SSOT) æ–‡æ¡£ï¼Œè¯·åŠ¡å¿…æŸ¥é˜…ï¼š

* ğŸ‘‰ **[åˆ†å±‚è¿è¡Œæ—¶ç¯å¢ƒæ¶æ„](../runtime/layered-runtime-architecture.md#3-patching-æœºåˆ¶-the-patching-mechanism)**

Mnemosyne åœ¨æ­¤è¿‡ç¨‹ä¸­æ‰®æ¼”æ‰§è¡Œè€…çš„è§’è‰²ï¼Œä½†ä¸æ˜¯æ¯æ¬¡æ¨ç†æ—¶ä¸´æ—¶è®¡ç®—ï¼Œè€Œæ˜¯é‡‡ç”¨ **ä¸Šä¸‹æ–‡ç”Ÿå‘½å‘¨æœŸ (Context Lifecycle)** ç®¡ç†ï¼š

1. **Context Load (åŠ è½½)**: å½“ç”¨æˆ·æ¿€æ´»è§’è‰²æˆ–åˆ‡æ¢å­˜æ¡£æ—¶ï¼ŒMnemosyne è¯»å– L2 é™æ€èµ„æºï¼Œå¹¶ç«‹å³åº”ç”¨ L3 ä¸­çš„æŒä¹…åŒ– Patchesï¼Œåœ¨å†…å­˜ä¸­æ„å»ºå‡º **Projected Entity**ã€‚
2. **Runtime Sync (è¿è¡Œæ—¶åŒæ­¥)**: æ‰€æœ‰çš„å±æ€§å˜æ›´è¯·æ±‚ï¼ˆå¦‚è„šæœ¬ä¿®æ”¹ï¼‰ç›´æ¥ä½œç”¨äºå†…å­˜ä¸­çš„ Projected Entityï¼Œç¡®ä¿å³æ—¶ç”Ÿæ•ˆã€‚
3. **Persist (æŒä¹…åŒ–)**: å˜æ›´åŒæ—¶è¢«æ•è·å¹¶å›å†™åˆ° L3 çš„ `patches` ç»“æ„ä¸­ï¼Œç¡®ä¿çŠ¶æ€åœ¨ä¼šè¯ç»“æŸæˆ–åˆ‡æ¢åå¾—ä»¥ä¿å­˜ã€‚

---

## 7. é«˜çº§ç‰¹æ€§ï¼šåŠ¨æ€ä½œç”¨åŸŸä¸ ACL (Advanced Features)

Mnemosyne å¼•å…¥äº†åŠ¨æ€ä½œç”¨åŸŸ (Dynamic Scopes) ä¸è®¿é—®æ§åˆ¶åˆ—è¡¨ (ACL)ï¼Œä»¥å¤„ç†å¤æ‚çš„å¤šè§’è‰²äº’åŠ¨ä¸éšç§ä¿æŠ¤ã€‚

### 7.1 ä½œç”¨åŸŸå®šä¹‰

| ä½œç”¨åŸŸ (Scope) | å®šä¹‰ | å¯è§æ€§è§„åˆ™ | å…¸å‹åº”ç”¨ |
| :--- | :--- | :--- | :--- |
| **Global (å…¨å±€)** | å…¬å¼€çš„äº‹å® | æ‰€æœ‰è§’è‰²ã€ç³»ç»Ÿæ—ç™½å¯è§ | å¤©æ°”ã€å…¬å…±åœºæ‰€äº‹ä»¶ |
| **Shared (å…±äº«)** | ç‰¹å®šç¾¤ä½“å…±äº« | ä»… `participants` åˆ—è¡¨ä¸­çš„è§’è‰²å¯è§ | ä¸¤äººçº¦ä¼šã€ç‰¹å®šå°å›¢ä½“ |
| **Private (ç§æœ‰)** | è§’è‰²å†…å¿ƒç‹¬ç™½ | ä»… Owner å¯è§ | æ—¥è®°ã€å†…å¿ƒç‹¬ç™½ |
| **Conditional (æ¡ä»¶)** | éœ€æ»¡è¶³ç‰¹å®šæ¡ä»¶ | æ»¡è¶³ `condition` (å¦‚å¥½æ„Ÿåº¦ > 90) å¯è§ | éšè—å‰§æƒ…ã€ç‰¹å®šå›å¿† |

### 7.2 ACL æ£€æŸ¥æœºåˆ¶

æ£€ç´¢æ—¶ï¼ŒMnemosyne ä¼šè‡ªåŠ¨æ‰§è¡Œ ACL è¿‡æ»¤ï¼š
1. æ£€æŸ¥å½“å‰æ´»è·ƒè§’è‰² (Active Character)ã€‚
2. éå†è®°å¿†ç‰‡æ®µï¼ŒéªŒè¯ `canAccessMemory(actor, memory)`ã€‚
3. ä»…è¿”å›é€šè¿‡éªŒè¯çš„ç‰‡æ®µï¼Œé˜²æ­¢ä¿¡æ¯æ³„æ¼ï¼ˆå¦‚ B çŸ¥é“ A çš„ç§å¯†æƒ³æ³•ï¼‰ã€‚

---

## 8. è®°å¿†ç”Ÿå‘½å‘¨æœŸç®¡ç† (Memory Lifecycle Management)

Mnemosyne ä¸ä»…æ˜¯é™æ€æ•°æ®çš„å­˜å‚¨å™¨ï¼Œæ›´æ˜¯è®°å¿†å…¨ç”Ÿå‘½å‘¨æœŸçš„ç®¡ç†è€…ã€‚ä¸ºäº†æ”¯æŒé•¿çº¿å™äº‹å¹¶ä¼˜åŒ–ä¸Šä¸‹æ–‡æ•ˆç‡ï¼Œå¼•æ“å¼•å…¥äº† **åˆ†æµ (Triage)** å’Œ **æ•´åˆ (Consolidation)** æœºåˆ¶ï¼Œå°†åŸæœ¬å¹³é“ºç›´å™çš„ LLM äº¤äº’è½¬åŒ–ä¸ºç»“æ„åŒ–çš„é•¿æœŸèµ„äº§ã€‚

è¯¦ç»†çš„ä¸šåŠ¡åœºæ™¯å®ç°è§„èŒƒï¼ˆä»¥ Galgame ä¸ºä¾‹ï¼‰ï¼Œè¯·å‚è€ƒï¼š
* ğŸ‘‰ **[Galgame ç‰¹åŒ–è®°å¿†ç³»ç»Ÿè®¾è®¡è§„èŒƒ](../../plans/galgame-memory-system-spec.md)**

### 8.1 è¾“å…¥åˆ†æµ (Input Triage)

å¹¶éæ‰€æœ‰çš„ç”¨æˆ·äº¤äº’éƒ½å…·æœ‰åŒç­‰çš„å™äº‹æƒé‡ã€‚Mnemosyne å»ºè®®åœ¨ä¸»æ¨ç†å¾ªç¯ä¹‹å‰å¼•å…¥ **Ingestion Pipeline**ï¼Œå¯¹è¾“å…¥æ„å›¾è¿›è¡Œåˆ†çº§å¤„ç†ã€‚

1.  **æ•°å€¼åŒ–äº¤äº’ (Numerical Route)**:
    *   é’ˆå¯¹é«˜é¢‘ã€é‡å¤ã€ä½ä¿¡æ¯é‡çš„è¡Œä¸ºï¼ˆå¦‚â€œæ‘¸å¤´â€ã€â€œç­¾åˆ°â€ï¼‰ã€‚
    *   **å¤„ç†**: ç›´æ¥è½¬åŒ–ä¸º VWD çŠ¶æ€æ ‘çš„æ•°å€¼å˜æ›´ï¼ˆå¦‚ `affinity +1`ï¼‰ï¼Œ**ä¸è¿›å…¥** é•¿æœŸå™äº‹é“¾ (History Chain)ã€‚
    *   **ä¼˜åŠ¿**: é¿å…ä¸Šä¸‹æ–‡çª—å£è¢«æ— æ„ä¹‰çš„é‡å¤æ–‡æœ¬æ±¡æŸ“ï¼ŒåŒæ—¶ä¿ç•™è¡Œä¸ºçš„é•¿æ•ˆå½±å“ã€‚
2.  **äº‹ä»¶åŒ–äº¤äº’ (Event Route)**:
    *   é’ˆå¯¹å…³é”®å‰§æƒ…èŠ‚ç‚¹ã€é‡å¤§æŠ‰æ‹©æˆ–å¤æ‚å¯¹è¯ã€‚
    *   **å¤„ç†**: å®Œæ•´è®°å½•å¯¹è¯å†å²ï¼Œå¹¶è§¦å‘ **Event Recorder** ç”Ÿæˆç»“æ„åŒ–äº‹ä»¶ã€‚

> **Galgame å®ç°**: å‚è§è§„èŒƒä¸­çš„ **Pre-Flash** æœºåˆ¶ï¼Œå®ƒé€šè¿‡è½»é‡çº§æ¨¡å‹å¯¹ç”¨æˆ·æ„å›¾è¿›è¡Œåˆ†ç±» (Routine vs Event)ï¼Œå¹¶åŠ¨æ€æŒ‚è½½ç›¸åº”çš„ Schemaã€‚

### 8.2 è®°å¿†æ•´åˆä¸å½’æ¡£ (Consolidation & Archival)

éšç€å¯¹è¯è¿›è¡Œï¼Œæ´»è·ƒä¸Šä¸‹æ–‡ (Active Context) æœ€ç»ˆä¼šè¶…å‡ºçª—å£é™åˆ¶ã€‚Mnemosyne é€šè¿‡å¼‚æ­¥çš„ **Consolidation Worker** å°†çŸ­æœŸè®°å¿†è½¬åŒ–ä¸ºé•¿æœŸè®°å¿†ã€‚

**æ ¸å¿ƒæµç¨‹**:

1.  **Log Consolidation (æ—¥å¿—å‹ç¼©)**: è¯»å–ç¼“å†²åŒºå†…çš„åŸå§‹å¯¹è¯ï¼Œç”Ÿæˆç²¾ç®€æ‘˜è¦ã€‚
2.  **Event Extraction (äº‹ä»¶æå–)**: ä»éç»“æ„åŒ–å¯¹è¯ä¸­æå–ç»“æ„åŒ–äº‹å®ï¼ˆå¦‚â€œå»è¿‡åœ°ç‚¹Xâ€ï¼Œâ€œè·å¾—ç‰©å“Yâ€ï¼‰ï¼Œå­˜å…¥ **Event Chain**ã€‚
3.  **Reflection (åæ€ä¸å†…åŒ–)**: ç”Ÿæˆè§’è‰²çš„ä¸»è§‚è®°å¿†æˆ–ç§æœ‰æ—¥å¿— (Private Logs)ï¼Œå­˜å…¥å‘é‡æ•°æ®åº“ä»¥ä¾› RAG æ£€ç´¢ã€‚
4.  **Archival (å½’æ¡£)**: åŸå§‹å¯¹è¯ç§»å…¥å†·å­˜å‚¨ (Cold Storage)ï¼Œä»æ´»è·ƒä¸Šä¸‹æ–‡ä¸­ç§»é™¤ã€‚

> **Galgame å®ç°**: å‚è§è§„èŒƒä¸­çš„ **Post-Flash** æœºåˆ¶ï¼Œå®ƒåœ¨ç¼“å†²åŒºæ»¡æˆ–ä¼šè¯ç»“æŸæ—¶è§¦å‘ï¼Œè´Ÿè´£ç”Ÿæˆè§’è‰²çš„â€œå†…å¿ƒç‹¬ç™½â€å¹¶æ›´æ–°å…¨å±€äº‹ä»¶è¡¨ã€‚

---

## é™„å½• A: å®Œæ•´ Schema ç¤ºä¾‹ (v1.1)

(åŸ 4.4 èŠ‚å†…å®¹ç§»åŠ¨è‡³æ­¤)

```json
{
  "character": {
    "$meta": {
      "extensible": false,
      "required": ["name", "description"]
    },
    "name": "Alice",
    "description": "A shy healer from the forest."
  },
  "session_state": {
    "$meta": {
      "extensible": true
    },
    "patches": {
      "character.description": "A brave warrior protecting her village."
    },
    "history": []
  }
}
```
